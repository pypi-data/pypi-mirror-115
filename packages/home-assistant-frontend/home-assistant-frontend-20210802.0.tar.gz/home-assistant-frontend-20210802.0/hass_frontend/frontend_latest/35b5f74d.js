(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([[6054],{23682:(t,e,n)=>{"use strict";function r(t,e){if(e.length<t)throw new TypeError(t+" argument"+(t>1?"s":"")+" required, but only "+e.length+" present")}n.d(e,{Z:()=>r})},90394:(t,e,n)=>{"use strict";function r(t){if(null===t||!0===t||!1===t)return NaN;var e=Number(t);return isNaN(e)?e:e<0?Math.ceil(e):Math.floor(e)}n.d(e,{Z:()=>r})},59699:(t,e,n)=>{"use strict";n.d(e,{Z:()=>a});var r=n(90394),s=n(39244),i=n(23682),o=36e5;function a(t,e){(0,i.Z)(2,arguments);var n=(0,r.Z)(e);return(0,s.Z)(t,n*o)}},39244:(t,e,n)=>{"use strict";n.d(e,{Z:()=>o});var r=n(90394),s=n(34327),i=n(23682);function o(t,e){(0,i.Z)(2,arguments);var n=(0,s.Z)(t).getTime(),o=(0,r.Z)(e);return new Date(n+o)}},93752:(t,e,n)=>{"use strict";n.d(e,{Z:()=>i});var r=n(34327),s=n(23682);function i(t){(0,s.Z)(1,arguments);var e=(0,r.Z)(t);return e.setHours(23,59,59,999),e}},70390:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var r=n(93752);function s(){return(0,r.Z)(Date.now())}},61334:(t,e,n)=>{"use strict";function r(){var t=new Date,e=t.getFullYear(),n=t.getMonth(),r=t.getDate(),s=new Date(0);return s.setFullYear(e,n,r-1),s.setHours(23,59,59,999),s}n.d(e,{Z:()=>r})},59429:(t,e,n)=>{"use strict";n.d(e,{Z:()=>i});var r=n(34327),s=n(23682);function i(t){(0,s.Z)(1,arguments);var e=(0,r.Z)(t);return e.setHours(0,0,0,0),e}},27088:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var r=n(59429);function s(){return(0,r.Z)(Date.now())}},83008:(t,e,n)=>{"use strict";function r(){var t=new Date,e=t.getFullYear(),n=t.getMonth(),r=t.getDate(),s=new Date(0);return s.setFullYear(e,n,r-1),s.setHours(0,0,0,0),s}n.d(e,{Z:()=>r})},34327:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var r=n(23682);function s(t){(0,r.Z)(1,arguments);var e=Object.prototype.toString.call(t);return t instanceof Date||"object"==typeof t&&"[object Date]"===e?new Date(t.getTime()):"number"==typeof t||"[object Number]"===e?new Date(t):("string"!=typeof t&&"[object String]"!==e||"undefined"==typeof console||(console.warn("Starting with v2.0.0-beta.1 date-fns doesn't accept strings as date arguments. Please use `parseISO` to parse strings. See: https://git.io/fjule"),console.warn((new Error).stack)),new Date(NaN))}},11950:(t,e,n)=>{"use strict";n.d(e,{l:()=>r});const r=async(t,e)=>new Promise((n=>{const r=e(t,(t=>{r(),n(t)}))}))},81582:(t,e,n)=>{"use strict";n.d(e,{LZ:()=>r,pB:()=>s,SO:()=>i,iJ:()=>o,Nn:()=>a,Ny:()=>u,T0:()=>c});const r=2143==n.j?["migration_error","setup_error","setup_retry"]:null,s=t=>t.callApi("GET","config/config_entries/entry"),i=(t,e,n)=>t.callWS({type:"config_entries/update",entry_id:e,...n}),o=(t,e)=>t.callApi("DELETE",`config/config_entries/entry/${e}`),a=(t,e)=>t.callApi("POST",`config/config_entries/entry/${e}/reload`),u=(t,e)=>t.callWS({type:"config_entries/disable",entry_id:e,disabled_by:"user"}),c=(t,e)=>t.callWS({type:"config_entries/disable",entry_id:e,disabled_by:null})},55424:(t,e,n)=>{"use strict";n.d(e,{Bm:()=>g,o1:()=>f,iK:()=>p,rl:()=>m,ZC:()=>b,_Z:()=>w,Jj:()=>v,UB:()=>S});var r=n(59699),s=n(27088),i=n(83008),o=n(70390),a=n(61334),u=n(95282),c=n(11950),l=n(81582),_=n(74186),y=n(58763);const d=[],g=()=>({stat_energy_from:"",stat_cost:null,entity_energy_from:null,entity_energy_price:null,number_energy_price:null}),f=()=>({stat_energy_to:"",stat_compensation:null,entity_energy_to:null,entity_energy_price:null,number_energy_price:null}),p=()=>({type:"grid",flow_from:[],flow_to:[],cost_adjustment_day:0}),m=()=>({type:"solar",stat_energy_from:"",config_entry_solar_forecast:null}),h=t=>t.callWS({type:"energy/info"}),b=t=>t.callWS({type:"energy/get_prefs"}),w=async(t,e)=>{const n=t.callWS({type:"energy/save_prefs",...e});return Z(t),n},v=t=>{const e={};for(const n of t.energy_sources)n.type in e?e[n.type].push(n):e[n.type]=[n];return e},Z=t=>{d.forEach((e=>{const n=S(t,{key:e});n.clearPrefs(),n._active&&n.refresh()}))},S=(t,e={})=>{let n="_energy";if(e.key){if(!e.key.startsWith("energy_"))throw new Error("Key need to start with energy_");n=`_${e.key}`}if(t.connection[n])return t.connection[n];d.push(e.key||"energy");const g=(0,u._)(t.connection,n,(async()=>{if(g.prefs||(g.prefs=await b(t)),g._refreshTimeout&&clearTimeout(g._refreshTimeout),g._active&&(!g.end||g.end>new Date)){const t=new Date;t.getMinutes()>20&&t.setHours(t.getHours()+1),t.setMinutes(20),g._refreshTimeout=window.setTimeout((()=>g.refresh()),t.getTime()-Date.now())}return(async(t,e,n,s)=>{const[i,o,a]=await Promise.all([(0,l.pB)(t),(0,c.l)(t.connection,_.LM),h(t)]),u=i.find((t=>"co2signal"===t.domain));let d;if(u)for(const e of o){if(e.config_entry_id!==u.entry_id)continue;const n=t.states[e.entity_id];if(n&&"%"===n.attributes.unit_of_measurement){d=n.entity_id;break}}const g=[];void 0!==d&&g.push(d);for(const t of e.energy_sources)if("solar"!==t.type){for(const e of t.flow_from){g.push(e.stat_energy_from),e.stat_cost&&g.push(e.stat_cost);const t=a.cost_sensors[e.stat_energy_from];t&&g.push(t)}for(const e of t.flow_to){g.push(e.stat_energy_to),e.stat_compensation&&g.push(e.stat_compensation);const t=a.cost_sensors[e.stat_energy_to];t&&g.push(t)}}else g.push(t.stat_energy_from);return{start:n,end:s,info:a,prefs:e,stats:await(0,y.dL)(t,(0,r.Z)(n,-1),s,g),co2SignalConfigEntry:u,co2SignalEntity:d}})(t,g.prefs,g.start,g.end)})),f=g.subscribe;g.subscribe=t=>{const e=f(t);return g._active++,()=>{g._active--,g._active<1&&(clearTimeout(g._refreshTimeout),g._refreshTimeout=void 0),e()}},g._active=0,g.prefs=e.prefs;const p=new Date;g.start=p.getHours()>0?(0,s.Z)():(0,i.Z)(),g.end=p.getHours()>0?(0,o.Z)():(0,a.Z)();const m=()=>{g._updatePeriodTimeout=window.setTimeout((()=>{g.start=(0,s.Z)(),g.end=(0,o.Z)(),m()}),(0,r.Z)((0,o.Z)(),1).getTime()-Date.now())};return m(),g.clearPrefs=()=>{g.prefs=void 0},g.setPeriod=(t,e)=>{var n;g.start=t,g.end=e,g._updatePeriodTimeout&&(clearTimeout(g._updatePeriodTimeout),g._updatePeriodTimeout=void 0),g.start.getTime()===(0,s.Z)().getTime()&&(null===(n=g.end)||void 0===n?void 0:n.getTime())===(0,o.Z)().getTime()&&m()},g}},74186:(t,e,n)=>{"use strict";n.d(e,{eD:()=>o,Mw:()=>a,vA:()=>u,L3:()=>c,Nv:()=>l,z3:()=>_,LM:()=>g});var r=n(95282),s=n(91741),i=n(38346);const o=(t,e)=>e.find((e=>t.states[e.entity_id]&&"battery"===t.states[e.entity_id].attributes.device_class)),a=(t,e)=>e.find((e=>t.states[e.entity_id]&&"battery_charging"===t.states[e.entity_id].attributes.device_class)),u=(t,e)=>{if(e.name)return e.name;const n=t.states[e.entity_id];return n?(0,s.C)(n):null},c=(t,e)=>t.callWS({type:"config/entity_registry/get",entity_id:e}),l=(t,e,n)=>t.callWS({type:"config/entity_registry/update",entity_id:e,...n}),_=(t,e)=>t.callWS({type:"config/entity_registry/remove",entity_id:e}),y=t=>t.sendMessagePromise({type:"config/entity_registry/list"}),d=(t,e)=>t.subscribeEvents((0,i.D)((()=>y(t).then((t=>e.setState(t,!0)))),500,!0),"entity_registry_updated"),g=(t,e)=>(0,r.B)("_entityRegistry",y,d,t,e)},58763:(t,e,n)=>{"use strict";n.d(e,{vq:()=>u,_J:()=>c,Nu:()=>_,uR:()=>y,dL:()=>d,Kj:()=>g,q6:()=>f,Nw:()=>p,m2:()=>h});var r=n(29171),s=n(22311),i=n(91741);const o=["climate","humidifier","water_heater"],a=["temperature","current_temperature","target_temp_low","target_temp_high","hvac_action","humidity","mode"],u=(t,e,n,r,s=!1,i,o=!0)=>{let a="history/period";return n&&(a+="/"+n.toISOString()),a+="?filter_entity_id="+e,r&&(a+="&end_time="+r.toISOString()),s&&(a+="&skip_initial_state"),void 0!==i&&(a+=`&significant_changes_only=${Number(i)}`),o&&(a+="&minimal_response"),t.callApi("GET",a)},c=(t,e,n,r)=>t.callApi("GET",`history/period/${e.toISOString()}?end_time=${n.toISOString()}&minimal_response${r?`&filter_entity_id=${r}`:""}`),l=(t,e)=>t.state===e.state&&(!t.attributes||!e.attributes||a.every((n=>t.attributes[n]===e.attributes[n]))),_=(t,e,n)=>{const u={},c=[];if(!e)return{line:[],timeline:[]};e.forEach((e=>{if(0===e.length)return;const o=e.find((t=>t.attributes&&"unit_of_measurement"in t.attributes));let a;a=o?o.attributes.unit_of_measurement:{climate:t.config.unit_system.temperature,counter:"#",humidifier:"%",input_number:"#",number:"#",water_heater:t.config.unit_system.temperature}[(0,s.N)(e[0])],a?a in u?u[a].push(e):u[a]=[e]:c.push(((t,e,n)=>{const s=[],o=n.length-1;for(const i of n)s.length>0&&i.state===s[s.length-1].state||(i.entity_id||(i.attributes=n[o].attributes,i.entity_id=n[o].entity_id),s.push({state_localize:(0,r.D)(t,i,e),state:i.state,last_changed:i.last_changed}));return{name:(0,i.C)(n[0]),entity_id:n[0].entity_id,data:s}})(n,t.locale,e))}));return{line:Object.keys(u).map((t=>((t,e)=>{const n=[];for(const t of e){const e=t[t.length-1],r=(0,s.N)(e),u=[];for(const e of t){let t;if(o.includes(r)){t={state:e.state,last_changed:e.last_updated,attributes:{}};for(const n of a)n in e.attributes&&(t.attributes[n]=e.attributes[n])}else t=e;u.length>1&&l(t,u[u.length-1])&&l(t,u[u.length-2])||u.push(t)}n.push({domain:r,name:(0,i.C)(e),entity_id:e.entity_id,states:u})}return{unit:t,identifier:e.map((t=>t[0].entity_id)).join(""),data:n}})(t,u[t]))),timeline:c}},y=(t,e)=>t.callWS({type:"history/list_statistic_ids",statistic_type:e}),d=(t,e,n,r)=>t.callWS({type:"history/statistics_during_period",start_time:e.toISOString(),end_time:null==n?void 0:n.toISOString(),statistic_ids:r}),g=t=>{if(!t||t.length<2)return null;const e=t[t.length-1].sum;if(null===e)return null;const n=t[0].sum;return null===n?e:e-n},f=(t,e)=>{let n=null;for(const r of e){if(!(r in t))continue;const e=g(t[r]);null!==e&&(null===n?n=e:n+=e)}return n},p=(t,e)=>t.some((t=>null!==t[e])),m=t=>{let e=null,n=null;for(const r of t){if(0===r.length)continue;const t=new Date(r[0].start);null!==e?t<n&&(e=r[0].start,n=t):(e=r[0].start,n=t)}return e},h=(t,e)=>{let n=null;if(0===e.length)return null;const r=(t=>{const e=[],n=t.map((t=>[...t]));for(;n.some((t=>t.length>0));){const t=m(n);let r=0;for(const e of n){if(0===e.length)continue;if(e[0].start!==t)continue;const n=e.shift();n.sum&&(r+=n.sum)}e.push({start:t,sum:r})}return e})(e),s=[...t];let i=null;for(const e of r){if(new Date(e.start)>=new Date(t[0].start))break;i=e.sum}for(;s.length>0;){if(!r.length)return n;if(r[0].start!==s[0].start){new Date(r[0].start)<new Date(s[0].start)?r.shift():s.shift();continue}const t=r.shift(),e=s.shift();if(null!==i){const r=t.sum-i;null===n?n=r*(e.mean/100):n+=r*(e.mean/100)}i=t.sum}return n}},66054:(t,e,n)=>{"use strict";n.r(e),n.d(e,{EnergyStrategy:()=>s});var r=n(55424);class s{static async generateView(t){const e=t.hass,s={cards:[]};let i;try{i=await(0,r.ZC)(e)}catch(t){return"not_found"===t.code?(async()=>(await Promise.all([n.e(8161),n.e(8985),n.e(1657),n.e(3762),n.e(7521),n.e(363)]).then(n.bind(n,55158)),{type:"panel",cards:[{type:"custom:energy-setup-wizard-card"}]}))():(s.cards.push({type:"markdown",content:`An error occured while fetching your energy preferences: ${t.message}.`}),s)}s.type="sidebar";const o=i.energy_sources.find((t=>"grid"===t.type)),a=o&&o.flow_to.length,u=i.energy_sources.some((t=>"solar"===t.type));return t.narrow&&s.cards.push({type:"energy-date-selection",collection_key:"energy_dashboard",view_layout:{position:"sidebar"}}),o&&s.cards.push({title:"Energy usage",type:"energy-usage-graph",collection_key:"energy_dashboard"}),u&&s.cards.push({title:"Solar production",type:"energy-solar-graph",collection_key:"energy_dashboard"}),o&&s.cards.push({title:"Energy distribution",type:"energy-distribution",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),(o||u)&&s.cards.push({title:"Sources",type:"energy-sources-table",collection_key:"energy_dashboard"}),a&&s.cards.push({type:"energy-grid-neutrality-gauge",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),u&&a&&s.cards.push({type:"energy-solar-consumed-gauge",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),o&&s.cards.push({type:"energy-carbon-consumed-gauge",view_layout:{position:"sidebar"},collection_key:"energy_dashboard"}),i.device_consumption.length&&s.cards.push({title:"Monitor individual devices",type:"energy-devices-graph",collection_key:"energy_dashboard"}),s}}}}]);
//# sourceMappingURL=35b5f74d.js.map